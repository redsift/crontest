{
  "name": "crontest",
  "display-name": "Crontest Sift",
  "description": "",
  "author": "",
  "version": "1.0.0",
  "icon": "assets/blueprint.svg",
  "interfaces": {
    "summary": {
      "controller": "dist/js/controller.umd-es2015.min.js"
    }
  },
  "dag": {
    "inputs": {
      "rpc": {
        "trigger": {
          "methods": [
            "GET"
          ],
          "path": "/trigger"
        },
        "count": {
          "methods": [
            "GET"
          ],
          "path": "/count"
        },
        "countstore": {
          "methods": [
            "GET"
          ],
          "path": "/countstore"
        }
      }
    },
    "nodes": [
      {
        "#": "Migration Reindex Forensics",
        "input":{
          "bucket": "forensics-st",
          "select": "*/*"
        },
        "implementation": {
          "when": {
            "run": {
              "update": true,
              "install": false
            }
          },
          "qos": {
            "long":true
          }
        },
        "outputs":{
          "forensics-st":{ "discardValue": true}
        }
      },
      {
        "#": "RPC trigger",
        "input": {
          "bucket": "trigger"
        },
        "implementation": {
          "javascript": "server/rpc.js"
        },
        "outputs": {
          "trigger-st": {},
          "api_rpc": {}
        }
      },
      {
        "#": "Count docs",
        "input": {
          "bucket": "count",
          "get": [
            {
              "bucket": "session",
              "key": "rpc/uuid"
            }]
        },
        "implementation": {
          "go": "server/gow/counter/counter.go",
          "sandbox": "quay.io/redsift/sandbox-go-rocksdb:v5.8",
          "qos": {
            "large-storage": [
              "rocksdb_store_forensics:rw"
            ]
          }
        },
        "outputs": {
          "api_rpc": {}
        }
      },
      {
        "#": "Emit Node",
        "input": {
          "bucket": "trigger-st"
        },
        "implementation": {
          "javascript": "server/node1.js"
        },
        "outputs": {
          "forensics-st": {}
        }
      },
      {
        "#": "Update Forensics Index",
        "input": {
          "bucket": "forensics-st",
          "select": "*/*",
          "batchSize":1000
        },
        "implementation": {
          "go": "server/gow/emailload/load.go",
          "sandbox": "quay.io/redsift/sandbox-go-rocksdb:v5.8",
          "qos": {
            "large-storage": [
              "rocksdb_store_forensics:rw"
            ]
          }
        }
      },
      {
        "#": "Store counter emit */*",
        "input": {
          "bucket": "countstore"
        },
        "implementation": {
          "javascript": "server/staremiter.js"
        },
        "outputs": {
          "forensics-counter-st": {"discardValue": true}
        }
      },
       {
        "#": "Respond to countsize",
        "input": {
          "bucket": "forensics-counter-st",
          "select": "~/~",
          "computeOnEmptySelect": true,
          "get": [
            {
              "bucket": "session",
              "key": "rpc/uuid"
            }
          ]
        },
        "implementation": {
          "javascript": "server/count_response.js"
        },
        "outputs": {
          "api_rpc": {}
        }
      }
    ],
    "stores": {
      "session": {
        "import": "_session"
      },
      "forensics-st": {
        "key$schema": "string/string",
        "alias":["forensics-counter-st"]
      },
      "trigger-st": {
        "key$schema": "string"
      }
    },
    "outputs": {
      "exports": {
        "api_rpc": {
          "import": "_rpc"
        }
      }
    }
  }
}